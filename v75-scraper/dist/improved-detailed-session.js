import { chromium } from "playwright";
import * as fs from "fs";
async function improvedDetailedSession() {
    let browser = null;
    const v75Data = {
        date: "2025-09-13",
        track: "Bolln√§s",
        races: [],
        syncInfo: {
            lastSync: new Date().toISOString(),
            totalRaces: 0,
            totalHorses: 0,
            qualityScore: 0,
        },
    };
    try {
        console.log("üéØ F√ñRB√ÑTTRAD DETALJERAD V75-SESSION");
        console.log("====================================");
        console.log("üìã Instruktioner:");
        console.log("   1. En browser √∂ppnas nu");
        console.log("   2. Logga in med: jesSjo680 / Jeppe1599");
        console.log("   3. G√• till V75-sidan");
        console.log("   4. F√∂r varje avdelning (1-7):");
        console.log("      - Granska ALLA detaljer i tabellen");
        console.log("      - L√§s speltips och analyser");
        console.log("      - Anteckna loppinformation");
        console.log("      - Tryck ENTER n√§r du √§r klar med avdelningen");
        console.log("   5. Data sparas automatiskt efter varje avdelning");
        console.log("   6. St√§ng browsern n√§r du √§r helt klar");
        console.log("");
        browser = await chromium.launch({
            headless: false,
            args: ["--no-sandbox", "--disable-setuid-sandbox"],
        });
        const page = await browser.newPage();
        await page.setViewportSize({ width: 1920, height: 1080 });
        console.log("üåê √ñppnar ATG inloggningssida...");
        await page.goto("https://www.atg.se/logga-in", {
            waitUntil: "domcontentloaded",
            timeout: 60000,
        });
        console.log("‚úÖ Inloggningssida laddad!");
        console.log("üë§ Anv√§ndarnamn: jesSjo680");
        console.log("üîë L√∂senord: Jeppe1599");
        console.log("");
        console.log("üìã VAD DU SKA G√ñRA F√ñR VARJE AVDELNING:");
        console.log("   1. Logga in och g√• till V75-sidan");
        console.log("   2. F√∂r varje avdelning, granska:");
        console.log("      üìä LOPPINFORMATION:");
        console.log("         - Titel: 'Avdelning X, idag XX:XX'");
        console.log("         - Distans: '2640 m Voltstart'");
        console.log("         - Bana: 'L√§tt bana'");
        console.log("         - Prispengar: 'Pris: 125.000-62.500-...'");
        console.log("         - Pool: 'LOPP Oms√§ttning sammanslagen pool'");
        console.log("      üìã TABELLDATA (H√ÑST/KUSK kolumnen):");
        console.log("         - Nummer, namn, √•lder/k√∂n (t.ex. s4), kusk");
        console.log("         - V75%, TREND%, V-ODDS, P-ODDS");
        console.log("         - Tr√§nare och tipskommentar");
        console.log("         - Skor (¬¢¬¢, CC, ◊õ◊õ) och vagn (Va.)");
        console.log("         - Strukna h√§star (markerade med EJ)");
        console.log("      üí° SPELTIPS F√ñR AVDELNINGEN:");
        console.log("         - Alla speltips med h√§stnummer och text");
        console.log("         - Rankning: A, B, C");
        console.log("         - Spetsanalys");
        console.log("   3. Tryck ENTER n√§r avdelningen √§r granskad");
        console.log("   4. Data sparas automatiskt efter varje avdelning");
        console.log("");
        // Ta screenshot av inloggningssidan
        await page.screenshot({ path: "login-improved-session.png" });
        console.log("üì∏ Screenshot sparad som login-improved-session.png");
        // V√§nta p√• att anv√§ndaren ska logga in och komma till V75-sidan
        console.log("‚è≥ V√§ntar p√• att du ska logga in och komma till V75-sidan...");
        console.log("   (Tryck ENTER n√§r du √§r p√• V75-sidan och redo att b√∂rja)");
        // V√§nta p√• f√∂rsta ENTER (n√§r anv√§ndaren √§r p√• V75-sidan)
        await new Promise((resolve) => {
            process.stdin.once("data", () => {
                console.log("‚úÖ Anv√§ndaren √§r redo att b√∂rja med f√∂rb√§ttrad granskning!");
                resolve(void 0);
            });
        });
        // Nu g√•r vi igenom varje avdelning
        for (let avdelning = 1; avdelning <= 7; avdelning++) {
            console.log("");
            console.log(`üèÅ AVDELNING ${avdelning}/7 - F√ñRB√ÑTTRAD GRANSKNING`);
            console.log("================================================");
            console.log("üìã Vad du ska g√∂ra:");
            console.log(`   1. G√• till avdelning ${avdelning}`);
            console.log("   2. Granska ALLA detaljer:");
            console.log("      üìä Loppinformation (titel, distans, prispengar, pool)");
            console.log("      üìã Tabelldata (alla kolumner i H√ÑST/KUSK tabellen)");
            console.log("      üí° Speltips och analyser");
            console.log("      ‚ùå Strukna h√§star (markerade med EJ)");
            console.log("   3. Kvalitets√§kra att all data √§r korrekt");
            console.log("   4. Tryck ENTER n√§r du √§r klar med denna avdelning");
            console.log("");
            try {
                // Ta screenshot av avdelningen
                await page.screenshot({
                    path: `avdelning-${avdelning}-improved-start.png`,
                });
                console.log(`üì∏ Screenshot av avdelning ${avdelning} sparad`);
                // V√§nta p√• ENTER f√∂r denna avdelning
                await new Promise((resolve) => {
                    process.stdin.once("data", () => {
                        console.log(`‚úÖ Avdelning ${avdelning} granskad och klar!`);
                        resolve(void 0);
                    });
                });
                // H√§mta f√∂rb√§ttrad data fr√•n denna avdelning
                console.log(`üîç H√§mtar f√∂rb√§ttrad data fr√•n avdelning ${avdelning}...`);
                const improvedData = await page.evaluate((raceNum) => {
                    const bodyText = document.body.innerText;
                    // H√§mta loppinformation med b√§ttre regex
                    const raceInfo = {
                        title: "",
                        distance: "",
                        trackType: "",
                        trackCondition: "",
                        prizeMoney: "",
                        eligibility: "",
                        specialPrizes: "",
                        poolInfo: "",
                        eventDetails: "",
                    };
                    // S√∂k efter avdelning och tid
                    const titleMatch = bodyText.match(/Avdelning\s+(\d+).*?(\d{2}:\d{2})/);
                    if (titleMatch) {
                        raceInfo.title = `Avdelning ${titleMatch[1]}, idag ${titleMatch[2]}`;
                    }
                    // S√∂k efter distans och starttyp
                    const distanceMatch = bodyText.match(/(\d+)\s+m\s+(Voltstart|Autostart)/);
                    if (distanceMatch) {
                        raceInfo.distance = `${distanceMatch[1]} m ${distanceMatch[2]}`;
                    }
                    // S√∂k efter banf√∂rh√•llanden
                    const trackMatch = bodyText.match(/(L√§tt|Mjuk|H√•rd)\s+bana/);
                    if (trackMatch) {
                        raceInfo.trackCondition = `${trackMatch[1]} bana`;
                    }
                    // S√∂k efter prispengar
                    const prizeMatch = bodyText.match(/Pris:\s*([^.]+\d+\.\d+[^.]*)/);
                    if (prizeMatch) {
                        raceInfo.prizeMoney = prizeMatch[1];
                    }
                    // S√∂k efter poolinfo
                    const poolMatch = bodyText.match(/LOPP Oms√§ttning[^:]*:\s*([^)]+)/);
                    if (poolMatch) {
                        raceInfo.poolInfo = poolMatch[1];
                    }
                    // H√§mta h√§stdata med f√∂rb√§ttrad parsing
                    const horseRows = [];
                    // S√∂k efter h√§stnummer och namn (f√∂rb√§ttrad regex)
                    const horsePattern = /^(\d+)\s+([A-Z√Ö√Ñ√ñ][a-z√•√§√∂\s]+)\s+([a-z]\d+)\s+([A-Z√Ö√Ñ√ñ][a-z√•√§√∂\s]+)$/gm;
                    let horseMatch;
                    while ((horseMatch = horsePattern.exec(bodyText)) !== null) {
                        horseRows.push({
                            number: parseInt(horseMatch[1]),
                            name: horseMatch[2].trim(),
                            ageGender: horseMatch[3],
                            driver: horseMatch[4].trim(),
                        });
                    }
                    // Alternativ parsing f√∂r h√§star
                    if (horseRows.length === 0) {
                        // S√∂k efter h√§stnamn i tabellen
                        const tablePattern = /(\d+)\s+([A-Z√Ö√Ñ√ñ][a-z√•√§√∂\s]+)\s+([a-z]\d+)/g;
                        let tableMatch;
                        while ((tableMatch = tablePattern.exec(bodyText)) !== null) {
                            horseRows.push({
                                number: parseInt(tableMatch[1]),
                                name: tableMatch[2].trim(),
                                ageGender: tableMatch[3],
                                driver: "Ok√§nd", // Placeholder
                            });
                        }
                    }
                    // H√§mta speltips med f√∂rb√§ttrad parsing
                    const tipsPattern = /(\d+)\s+([A-Z√Ö√Ñ√ñ][a-z√•√§√∂\s]+):\s*"([^"]+)"/g;
                    const bettingTips = [];
                    let tipMatch;
                    while ((tipMatch = tipsPattern.exec(bodyText)) !== null) {
                        bettingTips.push({
                            horseNumber: parseInt(tipMatch[1]),
                            horseName: tipMatch[2].trim(),
                            tipText: tipMatch[3].trim(),
                            rank: "B", // Placeholder
                        });
                    }
                    // H√§mta rankning
                    const rankMatch = bodyText.match(/Rank:\s*([ABC]:\s*[\d,\s]+)/);
                    const ranking = rankMatch ? rankMatch[1] : "";
                    // H√§mta spetsanalys
                    const paceMatch = bodyText.match(/Spetsanalys[^:]*:\s*([^.]+)/);
                    const paceAnalysis = paceMatch ? paceMatch[1].trim() : "";
                    // R√§kna strukna h√§star
                    const scratchedCount = (bodyText.match(/EJ/g) || []).length;
                    return {
                        raceInfo,
                        horsesFound: horseRows.length,
                        horses: horseRows.slice(0, 20),
                        bettingTips: bettingTips.slice(0, 10),
                        ranking,
                        paceAnalysis,
                        bodyTextLength: bodyText.length,
                        currentUrl: window.location.href,
                        hasScratchedHorses: bodyText.includes("EJ") || bodyText.includes("struken"),
                        scratchedCount,
                        // Debug info
                        debugInfo: {
                            hasV75Text: bodyText.includes("V75"),
                            hasHorseText: bodyText.includes("H√§st"),
                            hasDriverText: bodyText.includes("Kusk"),
                            hasTipsText: bodyText.includes("Speltips"),
                            textLength: bodyText.length,
                        },
                    };
                }, avdelning);
                console.log(`üìä F√∂rb√§ttrad data fr√•n avdelning ${avdelning}:`);
                console.log(`   üèÅ Lopp: ${improvedData.raceInfo.title}`);
                console.log(`   üìè Distans: ${improvedData.raceInfo.distance}`);
                console.log(`   üèá H√§star hittade: ${improvedData.horsesFound}`);
                console.log(`   üí° Speltips: ${improvedData.bettingTips.length}`);
                console.log(`   ‚ùå Strukna h√§star: ${improvedData.scratchedCount}`);
                console.log(`   üîó URL: ${improvedData.currentUrl}`);
                console.log(`   üêõ Debug: V75=${improvedData.debugInfo.hasV75Text}, H√§st=${improvedData.debugInfo.hasHorseText}, Tips=${improvedData.debugInfo.hasTipsText}`);
                if (improvedData.horses.length > 0) {
                    console.log(`   üêé H√§star i avdelning ${avdelning}:`);
                    improvedData.horses.forEach((horse, index) => {
                        console.log(`      ${index + 1}. ${horse.number} - ${horse.name} (${horse.ageGender}) - ${horse.driver}`);
                    });
                }
                if (improvedData.bettingTips.length > 0) {
                    console.log(`   üí° Speltips f√∂r avdelning ${avdelning}:`);
                    improvedData.bettingTips.forEach((tip, index) => {
                        console.log(`      ${index + 1}. ${tip.horseNumber} ${tip.horseName}: "${tip.tipText}"`);
                    });
                }
                // Skapa detaljerat race-objekt
                const detailedRace = {
                    raceNumber: avdelning,
                    raceInfo: improvedData.raceInfo,
                    horses: improvedData.horses.map((horse) => ({
                        number: horse.number,
                        name: horse.name,
                        driver: horse.driver,
                        trainer: "Ok√§nd", // Placeholder
                        v75Percent: 0, // Placeholder
                        trendPercent: 0, // Placeholder
                        vOdds: 0, // Placeholder
                        pOdds: 0, // Placeholder
                        shoes: "CC", // Placeholder
                        wagon: "VA", // Placeholder
                        tipsComment: "", // Placeholder
                        scratched: false, // Placeholder
                        ageGender: horse.ageGender,
                    })),
                    bettingTips: improvedData.bettingTips,
                    paceAnalysis: improvedData.paceAnalysis,
                    qualityCheck: {
                        completed: true,
                        notes: `Manuellt granskad avdelning ${avdelning} - ${improvedData.horsesFound} h√§star, ${improvedData.bettingTips.length} tips`,
                        dataQuality: improvedData.horsesFound > 10
                            ? "excellent"
                            : improvedData.horsesFound > 5
                                ? "good"
                                : improvedData.horsesFound > 0
                                    ? "fair"
                                    : "poor",
                    },
                };
                v75Data.races.push(detailedRace);
                // Uppdatera sync-info
                v75Data.syncInfo.totalRaces = v75Data.races.length;
                v75Data.syncInfo.totalHorses = v75Data.races.reduce((sum, race) => sum + race.horses.length, 0);
                v75Data.syncInfo.qualityScore =
                    v75Data.races.reduce((sum, race) => {
                        return (sum +
                            (race.qualityCheck.dataQuality === "excellent"
                                ? 100
                                : race.qualityCheck.dataQuality === "good"
                                    ? 80
                                    : race.qualityCheck.dataQuality === "fair"
                                        ? 60
                                        : 40));
                    }, 0) / v75Data.races.length;
                // Spara data efter varje avdelning
                fs.writeFileSync("v75-improved-data.json", JSON.stringify(v75Data, null, 2));
                console.log(`üíæ F√∂rb√§ttrad data sparad efter avdelning ${avdelning}`);
                console.log(`üìä Kvalitetspo√§ng: ${v75Data.syncInfo.qualityScore.toFixed(1)}%`);
                // Ta screenshot efter avdelningen
                await page.screenshot({
                    path: `avdelning-${avdelning}-improved-slut.png`,
                });
                console.log(`üì∏ Screenshot efter avdelning ${avdelning} sparad`);
            }
            catch (error) {
                console.error(`‚ùå Fel vid avdelning ${avdelning}:`, error);
                // Forts√§tt med n√§sta avdelning √§ven om denna misslyckades
            }
        }
        console.log("");
        console.log("üéâ ALLA AVDELNINGAR KLARA - F√ñRB√ÑTTRAD GRANSKNING!");
        console.log("==================================================");
        console.log("üìä SAMMANFATTNING:");
        console.log(`   üèÅ Totalt avdelningar: ${v75Data.races.length}`);
        console.log(`   üêé Totalt h√§star: ${v75Data.syncInfo.totalHorses}`);
        console.log(`   üìä Kvalitetspo√§ng: ${v75Data.syncInfo.qualityScore.toFixed(1)}%`);
        console.log(`   ‚è∞ Senast synkroniserat: ${new Date(v75Data.syncInfo.lastSync).toLocaleString("sv-SE")}`);
        // Visa sammanfattning per avdelning
        v75Data.races.forEach((race) => {
            console.log(`   üèÅ Avdelning ${race.raceNumber}: ${race.horses.length} h√§star, ${race.bettingTips.length} tips, kvalitet: ${race.qualityCheck.dataQuality}`);
        });
        // Spara final data
        fs.writeFileSync("v75-improved-complete.json", JSON.stringify(v75Data, null, 2));
        console.log("üíæ Final f√∂rb√§ttrad data sparad som v75-improved-complete.json");
        console.log("");
        console.log("‚úÖ F√∂rb√§ttrad session slutf√∂rd!");
        console.log("üìÅ Screenshots sparade:");
        console.log("   - login-improved-session.png");
        for (let i = 1; i <= 7; i++) {
            console.log(`   - avdelning-${i}-improved-start.png`);
            console.log(`   - avdelning-${i}-improved-slut.png`);
        }
        // Visa sammanfattning och v√§nta p√• ENTER h√§r ist√§llet f√∂r i finally
        console.log("");
        console.log("üéØ SESSION HELT KLAR!");
        console.log("====================");
        console.log("üìã Sammanfattning:");
        console.log("   ‚úÖ Alla 7 avdelningar granskade");
        console.log("   üíæ Data sparad i JSON-filer");
        console.log("   üì∏ Screenshots tagna");
        console.log("   üîÑ Redo f√∂r n√§sta steg");
        console.log("");
        console.log("üöÄ Du kan nu:");
        console.log("   - Kolla sparad data i JSON-filerna");
        console.log("   - Uppdatera sync API:et med den nya datan");
        console.log("   - Testa appen med korrekt data");
        console.log("");
        console.log("‚ú® Tack f√∂r att du granskade alla avdelningar noggrant!");
        console.log("   (Tryck ENTER f√∂r att avsluta denna session)");
        // V√§nta p√• ENTER f√∂r att avsluta
        await new Promise((resolve) => {
            process.stdin.once("data", () => {
                console.log("üëã Session avslutad. Hej d√•!");
                resolve(void 0);
            });
        });
    }
    catch (error) {
        console.error("‚ùå Fel vid f√∂rb√§ttrad V75-session:", error);
    }
    finally {
        console.log("üîí Browser kommer att st√§ngas om 5 sekunder...");
        await new Promise((resolve) => setTimeout(resolve, 5000));
        if (browser) {
            await browser.close();
            console.log("‚úÖ Browser st√§ngd");
        }
    }
}
improvedDetailedSession();
//# sourceMappingURL=improved-detailed-session.js.map