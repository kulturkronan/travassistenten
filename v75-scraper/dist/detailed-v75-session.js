import { chromium } from "playwright";
import * as fs from "fs";
async function detailedV75Session() {
    let browser = null;
    const v75Data = {
        date: "2025-09-13",
        track: "Bolln√§s",
        races: [],
        syncInfo: {
            lastSync: new Date().toISOString(),
            totalRaces: 0,
            totalHorses: 0,
            qualityScore: 0,
        },
    };
    // Ladda befintlig data om den finns
    const dataFile = "v75-detailed-data.json";
    if (fs.existsSync(dataFile)) {
        try {
            const existingData = JSON.parse(fs.readFileSync(dataFile, "utf8"));
            v75Data.races = existingData.races || [];
            console.log(`üìÇ Laddade befintlig detaljerad data med ${v75Data.races.length} avdelningar`);
        }
        catch (error) {
            console.log("üìÇ Ingen befintlig detaljerad data hittades, b√∂rjar fr√•n b√∂rjan");
        }
    }
    try {
        console.log("üéØ DETALJERAD V75-DATA SESSION");
        console.log("===============================");
        console.log("üìã Instruktioner:");
        console.log("   1. En browser √∂ppnas nu");
        console.log("   2. Logga in med: jesSjo680 / Jeppe1599");
        console.log("   3. G√• till V75-sidan");
        console.log("   4. F√∂r varje avdelning (1-7):");
        console.log("      - Kolla ALLA detaljer i tabellen");
        console.log("      - L√§s speltips och analyser");
        console.log("      - Granska loppinformation");
        console.log("      - Tryck ENTER n√§r du √§r klar med avdelningen");
        console.log("   5. Data sparas automatiskt efter varje avdelning");
        console.log("   6. St√§ng browsern n√§r du √§r helt klar");
        console.log("");
        browser = await chromium.launch({
            headless: false,
            args: ["--no-sandbox", "--disable-setuid-sandbox"],
        });
        const page = await browser.newPage();
        await page.setViewportSize({ width: 1920, height: 1080 });
        console.log("üåê √ñppnar ATG inloggningssida...");
        await page.goto("https://www.atg.se/logga-in", {
            waitUntil: "domcontentloaded",
            timeout: 60000,
        });
        console.log("‚úÖ Inloggningssida laddad!");
        console.log("üë§ Anv√§ndarnamn: jesSjo680");
        console.log("üîë L√∂senord: Jeppe1599");
        console.log("");
        console.log("üìã VAD DU SKA G√ñRA F√ñR VARJE AVDELNING:");
        console.log("   1. Logga in och g√• till V75-sidan");
        console.log("   2. F√∂r varje avdelning, granska:");
        console.log("      üìä LOPPINFORMATION:");
        console.log("         - Titel och distans");
        console.log("         - Prispengar och poolinfo");
        console.log("         - Kvalifikationer och specialpriser");
        console.log("      üìã TABELLDATA:");
        console.log("         - H√§st/Kusk (nummer, namn, √•lder, kusk)");
        console.log("         - V75%, TREND%, V-ODDS, P-ODDS");
        console.log("         - Tr√§nare och tipskommentar");
        console.log("         - Skor och vagn");
        console.log("         - Strukna h√§star (markerade med EJ)");
        console.log("      üí° SPELTIPS:");
        console.log("         - Alla speltips f√∂r avdelningen");
        console.log("         - Rankning (A, B, C)");
        console.log("         - Spetsanalys");
        console.log("   3. Tryck ENTER n√§r avdelningen √§r granskad");
        console.log("   4. Data sparas automatiskt efter varje avdelning");
        console.log("");
        // Ta screenshot av inloggningssidan
        await page.screenshot({ path: "login-detailed-session.png" });
        console.log("üì∏ Screenshot sparad som login-detailed-session.png");
        // V√§nta p√• att anv√§ndaren ska logga in och komma till V75-sidan
        console.log("‚è≥ V√§ntar p√• att du ska logga in och komma till V75-sidan...");
        console.log("   (Tryck ENTER n√§r du √§r p√• V75-sidan och redo att b√∂rja)");
        // V√§nta p√• f√∂rsta ENTER (n√§r anv√§ndaren √§r p√• V75-sidan)
        await new Promise((resolve) => {
            process.stdin.once("data", () => {
                console.log("‚úÖ Anv√§ndaren √§r redo att b√∂rja med detaljerad granskning!");
                resolve(void 0);
            });
        });
        // Nu g√•r vi igenom varje avdelning
        for (let avdelning = 1; avdelning <= 7; avdelning++) {
            // Hoppa √∂ver avdelningar som redan √§r klara
            if (v75Data.races.some((race) => race.raceNumber === avdelning)) {
                console.log(`‚è≠Ô∏è  Avdelning ${avdelning} redan klar, hoppar √∂ver`);
                continue;
            }
            console.log("");
            console.log(`üèÅ AVDELNING ${avdelning}/7 - DETALJERAD GRANSKNING`);
            console.log("================================================");
            console.log("üìã Vad du ska g√∂ra:");
            console.log(`   1. G√• till avdelning ${avdelning}`);
            console.log("   2. Granska ALLA detaljer:");
            console.log("      üìä Loppinformation (titel, distans, prispengar)");
            console.log("      üìã Tabelldata (alla kolumner)");
            console.log("      üí° Speltips och analyser");
            console.log("      ‚ùå Strukna h√§star (markerade med EJ)");
            console.log("   3. Kvalitets√§kra att all data √§r korrekt");
            console.log("   4. Tryck ENTER n√§r du √§r klar med denna avdelning");
            console.log("");
            try {
                // Ta screenshot av avdelningen
                await page.screenshot({
                    path: `avdelning-${avdelning}-detailed-start.png`,
                });
                console.log(`üì∏ Screenshot av avdelning ${avdelning} sparad`);
                // V√§nta p√• ENTER f√∂r denna avdelning
                await new Promise((resolve) => {
                    process.stdin.once("data", () => {
                        console.log(`‚úÖ Avdelning ${avdelning} granskad och klar!`);
                        resolve(void 0);
                    });
                });
                // H√§mta detaljerad data fr√•n denna avdelning
                console.log(`üîç H√§mtar detaljerad data fr√•n avdelning ${avdelning}...`);
                const detailedData = await page.evaluate((raceNum) => {
                    const bodyText = document.body.innerText;
                    // H√§mta loppinformation
                    const raceInfo = {
                        title: "",
                        distance: "",
                        trackType: "",
                        trackCondition: "",
                        prizeMoney: "",
                        eligibility: "",
                        specialPrizes: "",
                        poolInfo: "",
                        eventDetails: "",
                    };
                    // S√∂k efter loppinformation
                    const titleMatch = bodyText.match(/Avdelning\s+\d+.*?(\d{2}:\d{2})/);
                    if (titleMatch) {
                        raceInfo.title = `Avdelning ${raceNum}, idag ${titleMatch[1]}`;
                    }
                    const distanceMatch = bodyText.match(/(\d+)\s+m\s+(Voltstart|Autostart)/);
                    if (distanceMatch) {
                        raceInfo.distance = `${distanceMatch[1]} m ${distanceMatch[2]}`;
                    }
                    const trackMatch = bodyText.match(/(L√§tt|Mjuk|H√•rd)\s+bana/);
                    if (trackMatch) {
                        raceInfo.trackCondition = `${trackMatch[1]} bana`;
                    }
                    // H√§mta h√§stdata med mer detaljerad parsing
                    const horseRows = [];
                    const horsePattern = /(\d+)\s+([A-Z√Ö√Ñ√ñ][a-z√•√§√∂\s]+)\s+([a-z]\d+)\s+([A-Z√Ö√Ñ√ñ][a-z√•√§√∂\s]+)/g;
                    let horseMatch;
                    while ((horseMatch = horsePattern.exec(bodyText)) !== null) {
                        horseRows.push({
                            number: parseInt(horseMatch[1]),
                            name: horseMatch[2].trim(),
                            ageGender: horseMatch[3],
                            driver: horseMatch[4].trim(),
                        });
                    }
                    // H√§mta speltips
                    const tipsPattern = /(\d+)\s+([A-Z√Ö√Ñ√ñ][a-z√•√§√∂\s]+):\s*"([^"]+)"/g;
                    const bettingTips = [];
                    let tipMatch;
                    while ((tipMatch = tipsPattern.exec(bodyText)) !== null) {
                        bettingTips.push({
                            horseNumber: parseInt(tipMatch[1]),
                            horseName: tipMatch[2].trim(),
                            tipText: tipMatch[3].trim(),
                        });
                    }
                    // H√§mta rankning
                    const rankMatch = bodyText.match(/Rank:\s*([ABC]:\s*[\d,\s]+)/);
                    const ranking = rankMatch ? rankMatch[1] : "";
                    // H√§mta spetsanalys
                    const paceMatch = bodyText.match(/Spetsanalys[^:]*:\s*([^.]+)/);
                    const paceAnalysis = paceMatch ? paceMatch[1].trim() : "";
                    return {
                        raceInfo,
                        horsesFound: horseRows.length,
                        horses: horseRows.slice(0, 20), // F√∂rsta 20 h√§starna
                        bettingTips: bettingTips.slice(0, 10), // F√∂rsta 10 tipsen
                        ranking,
                        paceAnalysis,
                        bodyTextLength: bodyText.length,
                        currentUrl: window.location.href,
                        hasScratchedHorses: bodyText.includes("EJ") || bodyText.includes("struken"),
                        scratchedCount: (bodyText.match(/EJ/g) || []).length,
                    };
                }, avdelning);
                console.log(`üìä Detaljerad data fr√•n avdelning ${avdelning}:`);
                console.log(`   üèÅ Lopp: ${detailedData.raceInfo.title}`);
                console.log(`   üìè Distans: ${detailedData.raceInfo.distance}`);
                console.log(`   üèá H√§star hittade: ${detailedData.horsesFound}`);
                console.log(`   üí° Speltips: ${detailedData.bettingTips.length}`);
                console.log(`   ‚ùå Strukna h√§star: ${detailedData.scratchedCount}`);
                console.log(`   üîó URL: ${detailedData.currentUrl}`);
                if (detailedData.horses.length > 0) {
                    console.log(`   üêé H√§star i avdelning ${avdelning}:`);
                    detailedData.horses.forEach((horse, index) => {
                        console.log(`      ${index + 1}. ${horse.number} - ${horse.name} (${horse.ageGender}) - ${horse.driver}`);
                    });
                }
                if (detailedData.bettingTips.length > 0) {
                    console.log(`   üí° Speltips f√∂r avdelning ${avdelning}:`);
                    detailedData.bettingTips.forEach((tip, index) => {
                        console.log(`      ${index + 1}. ${tip.horseNumber} ${tip.horseName}: "${tip.tipText}"`);
                    });
                }
                // Skapa detaljerat race-objekt
                const detailedRace = {
                    raceNumber: avdelning,
                    raceInfo: detailedData.raceInfo,
                    horses: detailedData.horses.map((horse) => ({
                        number: horse.number,
                        name: horse.name,
                        driver: horse.driver,
                        trainer: "Ok√§nd", // Placeholder
                        v75Percent: 0, // Placeholder
                        trendPercent: 0, // Placeholder
                        vOdds: 0, // Placeholder
                        pOdds: 0, // Placeholder
                        shoes: "CC", // Placeholder
                        wagon: "VA", // Placeholder
                        tipsComment: "", // Placeholder
                        scratched: false, // Placeholder
                        ageGender: horse.ageGender,
                    })),
                    bettingTips: detailedData.bettingTips.map((tip) => ({
                        ...tip,
                        rank: "B", // Placeholder - du f√•r uppdatera detta manuellt
                    })),
                    paceAnalysis: detailedData.paceAnalysis,
                    qualityCheck: {
                        completed: true,
                        notes: `Manuellt granskad avdelning ${avdelning}`,
                        dataQuality: detailedData.horsesFound > 10 ? "excellent" : "good",
                    },
                };
                v75Data.races.push(detailedRace);
                // Uppdatera sync-info
                v75Data.syncInfo.totalRaces = v75Data.races.length;
                v75Data.syncInfo.totalHorses = v75Data.races.reduce((sum, race) => sum + race.horses.length, 0);
                v75Data.syncInfo.qualityScore =
                    v75Data.races.reduce((sum, race) => {
                        return (sum +
                            (race.qualityCheck.dataQuality === "excellent"
                                ? 100
                                : race.qualityCheck.dataQuality === "good"
                                    ? 80
                                    : race.qualityCheck.dataQuality === "fair"
                                        ? 60
                                        : 40));
                    }, 0) / v75Data.races.length;
                // Spara data efter varje avdelning
                fs.writeFileSync(dataFile, JSON.stringify(v75Data, null, 2));
                console.log(`üíæ Detaljerad data sparad efter avdelning ${avdelning}`);
                console.log(`üìä Kvalitetspo√§ng: ${v75Data.syncInfo.qualityScore.toFixed(1)}%`);
                // Ta screenshot efter avdelningen
                await page.screenshot({
                    path: `avdelning-${avdelning}-detailed-slut.png`,
                });
                console.log(`üì∏ Screenshot efter avdelning ${avdelning} sparad`);
            }
            catch (error) {
                console.error(`‚ùå Fel vid avdelning ${avdelning}:`, error);
                // Forts√§tt med n√§sta avdelning √§ven om denna misslyckades
            }
        }
        console.log("");
        console.log("üéâ ALLA AVDELNINGAR KLARA - DETALJERAD GRANSKNING!");
        console.log("==================================================");
        console.log("üìä SAMMANFATTNING:");
        console.log(`   üèÅ Totalt avdelningar: ${v75Data.races.length}`);
        console.log(`   üêé Totalt h√§star: ${v75Data.syncInfo.totalHorses}`);
        console.log(`   üìä Kvalitetspo√§ng: ${v75Data.syncInfo.qualityScore.toFixed(1)}%`);
        console.log(`   ‚è∞ Senast synkroniserat: ${new Date(v75Data.syncInfo.lastSync).toLocaleString("sv-SE")}`);
        // Visa sammanfattning per avdelning
        v75Data.races.forEach((race) => {
            console.log(`   üèÅ Avdelning ${race.raceNumber}: ${race.horses.length} h√§star, ${race.bettingTips.length} tips, kvalitet: ${race.qualityCheck.dataQuality}`);
        });
        // Spara final data
        fs.writeFileSync("v75-detailed-complete.json", JSON.stringify(v75Data, null, 2));
        console.log("üíæ Final detaljerad data sparad som v75-detailed-complete.json");
        console.log("");
        console.log("‚úÖ Detaljerad session slutf√∂rd!");
        console.log("üìÅ Screenshots sparade:");
        console.log("   - login-detailed-session.png");
        for (let i = 1; i <= 7; i++) {
            console.log(`   - avdelning-${i}-detailed-start.png`);
            console.log(`   - avdelning-${i}-detailed-slut.png`);
        }
    }
    catch (error) {
        console.error("‚ùå Fel vid detaljerad V75-session:", error);
    }
    finally {
        console.log("üîí Browser kommer att st√§ngas om 5 sekunder...");
        await new Promise((resolve) => setTimeout(resolve, 5000));
        if (browser) {
            await browser.close();
            console.log("‚úÖ Browser st√§ngd");
        }
        console.log("");
        console.log("üéØ SESSION HELT KLAR!");
        console.log("====================");
        console.log("üìã Sammanfattning:");
        console.log("   ‚úÖ Alla 7 avdelningar granskade");
        console.log("   üíæ Data sparad i JSON-filer");
        console.log("   üì∏ Screenshots tagna");
        console.log("   üîÑ Redo f√∂r n√§sta steg");
        console.log("");
        console.log("üöÄ Du kan nu:");
        console.log("   - Kolla sparad data i JSON-filerna");
        console.log("   - Uppdatera sync API:et med den nya datan");
        console.log("   - Testa appen med korrekt data");
        console.log("");
        console.log("‚ú® Tack f√∂r att du granskade alla avdelningar noggrant!");
        console.log("   (Tryck ENTER f√∂r att avsluta denna session)");
        // V√§nta p√• ENTER f√∂r att avsluta
        await new Promise((resolve) => {
            process.stdin.once("data", () => {
                console.log("üëã Session avslutad. Hej d√•!");
                resolve(void 0);
            });
        });
    }
}
detailedV75Session();
//# sourceMappingURL=detailed-v75-session.js.map